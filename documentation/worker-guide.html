<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Worker Architecture Guide - TheQA Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 30px 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #374151;
        }

        .sidebar h1 {
            color: #60a5fa;
            margin-bottom: 30px;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #374151;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 12px;
        }

        .nav-menu a {
            color: #d1d5db;
            text-decoration: none;
            display: block;
            padding: 12px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .nav-menu a:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-left-color: #3b82f6;
            transform: translateX(5px);
        }

        .nav-menu a.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-left-color: #1d4ed8;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-x: hidden;
        }

        .section {
            margin-bottom: 80px;
            scroll-margin-top: 20px;
        }

        .section h1 {
            color: #1f2937;
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .section h2 {
            color: #3b82f6;
            font-size: 2.2rem;
            margin-bottom: 25px;
            margin-top: 50px;
            font-weight: 700;
            position: relative;
        }

        .section h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 2px;
        }

        .section h3 {
            color: #1f2937;
            font-size: 1.6rem;
            margin-bottom: 20px;
            margin-top: 35px;
            font-weight: 600;
        }

        .section h4 {
            color: #374151;
            font-size: 1.3rem;
            margin-bottom: 15px;
            margin-top: 25px;
            font-weight: 600;
        }

        .architecture-flow {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 40px 0;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 25px;
            margin: 30px 0;
        }

        .flow-step {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 25px;
            min-width: 160px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .flow-step:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .flow-step.user {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .flow-step.edge {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .flow-step.worker {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        .flow-step.kv {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }

        .flow-step.database {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        .flow-arrow {
            font-size: 2.5rem;
            color: #6b7280;
            font-weight: bold;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            overflow-x: auto;
            font-family: 'Fira Code', 'Courier New', monospace;
            position: relative;
            border: 1px solid #334155;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 12px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .concept-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .concept-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #3b82f6;
        }

        .concept-card h3 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .comparison-table th {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .comparison-table td {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        .comparison-table tr:nth-child(even) {
            background: #f9fafb;
        }

        .highlight-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
        }

        .highlight-box h3 {
            color: #92400e;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .metric-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #3b82f6;
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 15px;
        }

        .metric-value.excellent {
            color: #10b981;
        }

        .metric-value.good {
            color: #3b82f6;
        }

        .metric-value.warning {
            color: #f59e0b;
        }

        .metric-value.critical {
            color: #ef4444;
        }

        .endpoints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .endpoint-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .endpoint-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .endpoint-method {
            background: #3b82f6;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 15px;
        }

        .endpoint-method.post {
            background: #10b981;
        }

        ul, ol {
            margin: 20px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .pros, .cons {
            padding: 30px;
            border-radius: 15px;
        }

        .pros {
            background: #f0fdf4;
            border-left: 5px solid #22c55e;
        }

        .cons {
            background: #fef2f2;
            border-left: 5px solid #ef4444;
        }

        .pros h4 {
            color: #166534;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .cons h4 {
            color: #dc2626;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .pros ul, .cons ul {
            list-style: none;
            padding: 0;
        }

        .pros li::before {
            content: "✅ ";
            margin-right: 10px;
            font-weight: bold;
        }

        .cons li::before {
            content: "❌ ";
            margin-right: 10px;
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                padding: 20px;
            }

            .concept-grid {
                grid-template-columns: 1fr;
            }

            .pros-cons {
                grid-template-columns: 1fr;
            }

            .flow-diagram {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }
        }

        .toc {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border-left: 4px solid #3b82f6;
        }

        .toc h3 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .toc ul {
            list-style: none;
            padding: 0;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="sidebar">
            <h1>⚡ Worker Guide</h1>
            <ul class="nav-menu">
                <li><a href="#overview" class="active">🎯 Worker Overview</a></li>
                <li><a href="#request-flow">🔄 Request Processing Flow</a></li>
                <li><a href="#database">🗄️ Database Architecture</a></li>
                <li><a href="#core-functions">🔧 Core Functions Deep Dive</a></li>
                <li><a href="#country-detection">🌍 Country Detection & Routing</a></li>
                <li><a href="#content-injection">💉 Dynamic Content Injection</a></li>
                <li><a href="#performance">🚀 Performance Optimizations</a></li>
                <li><a href="#monitoring">📊 Monitoring & Analytics</a></li>
                <li><a href="#error-handling">🛡️ Error Handling</a></li>
                <li><a href="#api-endpoints">🔌 API Endpoints</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Overview Section -->
            <section id="overview" class="section">
                <h1>⚡ Cloudflare Worker Architecture Guide</h1>
                <p style="font-size: 1.2rem; margin-bottom: 30px; color: #6b7280;">
                    This comprehensive guide explains how the Cloudflare Worker powers the dynamic content delivery system for TheQA platform.
                </p>

                <div class="toc">
                    <h3>📋 Table of Contents</h3>
                    <ul>
                        <li><a href="#overview">1. Worker Overview</a></li>
                        <li><a href="#request-flow">2. Request Processing Flow</a></li>
                        <li><a href="#database">3. Database Architecture</a></li>
                        <li><a href="#core-functions">4. Core Functions Deep Dive</a></li>
                        <li><a href="#country-detection">5. Country Detection & Routing</a></li>
                        <li><a href="#content-injection">6. Dynamic Content Injection</a></li>
                        <li><a href="#performance">7. Performance Optimizations</a></li>
                        <li><a href="#monitoring">8. Monitoring & Analytics</a></li>
                        <li><a href="#error-handling">9. Error Handling</a></li>
                        <li><a href="#api-endpoints">10. API Endpoints</a></li>
                    </ul>
                </div>

                <h2>🎯 Worker Overview</h2>
                <p>The Cloudflare Worker acts as an <strong>intelligent proxy</strong> between users and the static Astro site, providing:</p>

                <div class="concept-grid">
                    <div class="concept-card">
                        <h3>🌍 Country Detection</h3>
                        <p>Automatic user location identification using Cloudflare's edge network and shows relevant brokers for their region.</p>
                    </div>
                    <div class="concept-card">
                        <h3>📊 Dynamic Content</h3>
                        <p>Country-specific broker data injection in real-time based on local regulations and preferences.</p>
                    </div>
                    <div class="concept-card">
                        <h3>🚀 Performance</h3>
                        <p>Multi-layer caching and optimization strategies ensuring lightning-fast performance with 85%+ cache hit rates.</p>
                    </div>
                    <div class="concept-card">
                        <h3>🛡️ Reliability</h3>
                        <p>Fallback mechanisms and comprehensive error handling for maximum uptime and user experience.</p>
                    </div>
                </div>

                <h3>🏗️ Worker Architecture</h3>
                <div class="architecture-flow">
                    <div class="flow-diagram">
                        <div class="flow-step user">
                            <strong>👤 Router</strong><br>
                            <small>Handler</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="flow-step edge">
                            <strong>⚡ Cache</strong><br>
                            <small>Manager</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="flow-step worker">
                            <strong>🔧 Database</strong><br>
                            <small>Manager</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="flow-step kv">
                            <strong>📊 Performance</strong><br>
                            <small>Monitor</small>
                        </div>
                        <div class="flow-arrow">→</div>
                        <div class="flow-step database">
                            <strong>📈 Analytics</strong><br>
                            <small>Tracker</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Request Processing Flow -->
            <section id="request-flow" class="section">
                <h2>🔄 Request Processing Flow</h2>
                <p>The complete request lifecycle from user request to response delivery, optimized for maximum performance.</p>

                <h3>📋 Complete Request Lifecycle</h3>
                <div class="code-block" data-lang="Request Processing">
// 1. Request Received
export default {
    async fetch(request, env, ctx) {
        const startTime = Date.now();
        const url = new URL(request.url);
        const userCountry = request.cf?.country || 'US';
        
        // 2. Route Analysis
        if (isStaticAsset(url.pathname)) {
            return fetch(request); // Pass through
        }
        
        // 3. Dynamic Route Check
        const shouldProcess = await checkDynamicRoute(env.DB, url.pathname);
        if (!shouldProcess) {
            return fetch(request); // Pass through
        }
        
        // 4. Cache Check
        const cacheKey = `broker-data-${userCountry}-v2`;
        let brokerData = await getCachedBrokerData(env.CACHE, cacheKey);
        
        // 5. Database Query (if cache miss)
        if (!brokerData) {
            brokerData = await getBrokersForCountry(env.DB, userCountry);
            await cacheBrokerData(env.CACHE, cacheKey, brokerData);
        }
        
        // 6. Content Processing
        const originalResponse = await fetch(request);
        let html = await originalResponse.text();
        
        // 7. Dynamic Injection
        html = injectBrokerData(html, brokerData, userCountry);
        
        // 8. Response with Headers
        return new Response(html, {
            headers: {
                'Content-Type': 'text/html; charset=utf-8',
                'Cache-Control': 'public, max-age=1800',
                'X-Country-Code': userCountry,
                'X-Processing-Time': `${Date.now() - startTime}ms`
            }
        });
    }
};</div>

                <h3>🔍 Processing Steps Explained</h3>
                <div class="concept-grid">
                    <div class="concept-card">
                        <h3>🌐 Request Reception</h3>
                        <p>Worker receives incoming request and extracts user country from Cloudflare headers</p>
                    </div>
                    <div class="concept-card">
                        <h3>🔍 Route Analysis</h3>
                        <p>Determine if route needs processing or can be passed through to origin</p>
                    </div>
                    <div class="concept-card">
                        <h3>🏃 Static Asset Check</h3>
                        <p>Skip processing for CSS/JS/images to maintain performance</p>
                    </div>
                    <div class="concept-card">
                        <h3>🎯 Dynamic Route Check</h3>
                        <p>Verify route needs broker data using optimized database queries</p>
                    </div>
                    <div class="concept-card">
                        <h3>🗄️ Cache Lookup</h3>
                        <p>Check KV storage for cached data to avoid database queries</p>
                    </div>
                    <div class="concept-card">
                        <h3>💾 Database Query</h3>
                        <p>Fetch fresh data if cache miss, with timeout protection</p>
                    </div>
                    <div class="concept-card">
                        <h3>📄 Content Fetching</h3>
                        <p>Get original HTML from Astro static site</p>
                    </div>
                    <div class="concept-card">
                        <h3>💉 Dynamic Injection</h3>
                        <p>Insert broker data into HTML using optimized string replacement</p>
                    </div>
                    <div class="concept-card">
                        <h3>📤 Response Delivery</h3>
                        <p>Return processed content with appropriate cache headers</p>
                    </div>
                </div>
            </section>

            <!-- Database Architecture -->
            <section id="database" class="section">
                <h2>🗄️ Database Architecture</h2>
                <p>Cloudflare D1 is a <strong>SQLite database</strong> that runs on Cloudflare's edge network. It serves as the source of truth for all broker data.</p>

                <h3>📊 D1 Database Schema</h3>
                <div class="code-block" data-lang="Database Schema">
-- Core broker information
CREATE TABLE brokers (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    slug TEXT UNIQUE,
    logo TEXT,
    rating REAL,
    min_deposit INTEGER,
    is_active BOOLEAN DEFAULT 1,
    default_sort INTEGER
);

-- Country-specific sorting
CREATE TABLE country_sorting (
    broker_id INTEGER,
    country_code TEXT,
    sort_order INTEGER,
    is_featured BOOLEAN DEFAULT 0
);

-- Restricted brokers by country
CREATE TABLE unsupported_countries (
    broker_id INTEGER,
    country_code TEXT,
    restriction_type TEXT,
    reason TEXT,
    alternative_id INTEGER,
    is_active BOOLEAN DEFAULT 1
);

-- Dynamic routes that need processing
CREATE TABLE dynamic_routes (
    id INTEGER PRIMARY KEY,
    route_pattern TEXT,
    is_active BOOLEAN DEFAULT 1
);</div>

                <h3>🔗 Database Relationships</h3>
                <div class="concept-grid">
                    <div class="concept-card">
                        <h3>🏦 Brokers → Country Sorting</h3>
                        <p>Each broker can have different sort orders per country for localized recommendations.</p>
                        <div class="code-block" data-lang="Example Data">
{
    "broker": "Exness",
    "countries": {
        "EG": { "sort_order": 1, "is_featured": true },
        "SA": { "sort_order": 3, "is_featured": false },
        "US": { "sort_order": 2, "is_featured": true }
    }
}</div>
                    </div>
                    <div class="concept-card">
                        <h3>🚫 Brokers → Unsupported Countries</h3>
                        <p>Track which brokers are restricted where and provide alternatives.</p>
                        <div class="code-block" data-lang="Restriction Data">
{
    "broker": "eVest",
    "restrictions": {
        "US": { 
            "type": "blocked", 
            "reason": "regulatory", 
            "alternative": "Exness" 
        },
        "CA": { 
            "type": "blocked", 
            "reason": "regulatory", 
            "alternative": "AvaTrade" 
        }
    }
}</div>
                    </div>
                    <div class="concept-card">
                        <h3>🛣️ Dynamic Routes</h3>
                        <p>Define which routes get dynamic processing for performance optimization.</p>
                        <div class="code-block" data-lang="Route Patterns">
[
    "شركات-تداول-مرخصة-في-السعودية",
    "reviews", 
    "brokers",
    "trading-companies"
]</div>
                    </div>
                </div>

                <h3>🚀 Performance Optimizations</h3>
                <div class="code-block" data-lang="Database Indexes">
-- Strategic indexes for maximum performance
CREATE INDEX idx_brokers_active_sort ON brokers(is_active, default_sort_order);
CREATE INDEX idx_country_sorting_optimized ON country_sorting(country_code, sort_order, broker_id);
CREATE INDEX idx_dynamic_routes_active_pattern ON dynamic_routes(is_active, route_pattern);

-- Query performance improvements:
-- Route checking: 90% faster (0-5ms from 10-50ms)
-- Broker fetching: 75% faster (5-20ms from 20-100ms)
-- Total query time: 80% faster (5-25ms from 30-150ms)</div>

                <div class="performance-metrics">
                    <div class="metric-card">
                        <div class="metric-value excellent">5-20ms</div>
                        <div>Query Response Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value excellent">95%</div>
                        <div>Load Reduction via Cache</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value good">6</div>
                        <div>Optimized Indexes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value excellent">99.9%</div>
                        <div>Uptime</div>
                    </div>
                </div>
            </section>
